<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jira Report Generator</title>

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa, #e4e8ec);
            min-height: 100vh;
            display: flex;
            align-items: center;
            font-family: system-ui, -apple-system, BlinkMacSystemFont;
        }
        .card {
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.08);
            border: none;
        }
        .logo {
            max-height: 54px;
        }
        .footer-text {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .badge {
            font-size: 0.75rem;
        }
    </style>
</head>

<body>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-7">
            <div class="card p-4">

                <!-- LOGO -->
                <div class="text-center mb-3">
                    <img src="/static/images/onmobile-logo.png" class="logo">
                </div>

                <div class="text-center mb-4">
                    <h4 class="fw-bold">Jira Report Generator</h4>
                    <p class="text-muted mb-0">Generate & download Jira reports instantly</p>
                </div>

                <!-- TABS -->
                <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active"
                                id="generate-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#generateTab"
                                type="button"
                                role="tab">
                            Generate Report
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="history-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#historyTab"
                                type="button"
                                role="tab">
                            Job History
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link"
                                id="scheduler-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#schedulerTab"
                                type="button"
                                role="tab">
                            Report Scheduler
                        </button>
                    </li>
                </ul>

                <div class="tab-content">

                    <!-- ================= GENERATE TAB ================= -->
                    <div class="tab-pane fade show active"
                         id="generateTab"
                         role="tabpanel"
                         aria-labelledby="generate-tab">

                        <form id="reportForm">

                            <div class="mb-3">
                                <label class="form-label fw-semibold">Report Type</label>
                                <select id="reportType" name="report_type" class="form-select" required>
                                    <option value="jira_infosol">JIRA-INFOSOL-Report</option>
                                    <option value="jira_ops">JIRA-OPS-Task-Bug-Report</option>
                                    <option value="jira_ops_cr">JIRA-OPS-CR-Report</option>
                                    <option value="jira_asd_incident">JIRA-ASD-INCIDENT-Report</option>
                                    <option value="jira_asd_pm">JIRA-ASD-PM-Report</option>
                                    <option value="jsm_incident">JSM-INCIDENT-Report</option>
                                </select>
                            </div>
							
							<!-- ðŸ”µ Status Selector -->
							<div class="mb-3">
								<label class="form-label fw-semibold">Status</label>
								<select
									name="statuses"
									id="statusSelect"
									class="form-select"
									multiple
								>
									<!-- Options will be injected by JS -->
								</select>
								<small class="text-muted">
									Hold Ctrl (Cmd on Mac) to select multiple statuses
								</small>
							</div>
							
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">Start Date</label>
                                    <input type="date" name="start_date" class="form-control" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-semibold">End Date</label>
                                    <input type="date" name="end_date" class="form-control">
                                </div>
                            </div>
							
							<div class="form-check mt-2">
								<input
									class="form-check-input"
									type="checkbox"
									id="tillNow"
									name="till_now"
									value="true"
								>
								<label class="form-check-label fw-semibold" for="tillNow">
									Till now
								</label>
								<div class="text-muted small">
									If checked, report runs till current time
								</div>
							</div>

                            <div class="d-grid mt-3">
                                <button id="submitBtn" type="submit" class="btn btn-primary btn-lg">
                                    Generate & Download CSV
                                </button>
                                <button id="cancelBtn" type="button"
                                        class="btn btn-outline-danger mt-2 d-none">
                                    Cancel Job
                                </button>
                            </div>

                            <!-- Progress -->
                            <div class="progress mt-3 d-none" id="progressBox" style="height:22px">
                                <div class="progress-bar progress-bar-striped progress-bar-animated"
                                     id="progressBar" style="width:0%">0%</div>
                            </div>
                            <div class="text-center mt-2 fw-semibold" id="progressText"></div>
                        </form>
                    </div>

                    <!-- ================= HISTORY TAB ================= -->
                    <div class="tab-pane fade"
                         id="historyTab"
                         role="tabpanel"
                         aria-labelledby="history-tab">

                        <div class="card">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">Job History</h6>

                                <div class="table-responsive" style="max-height: 60vh;">
                                    <table class="table table-sm table-striped align-middle">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Report</th>
                                                <th>Status</th>
                                                <th>Rows</th>
                                                <th>Started (IST)</th>
                                                <th>Ended (IST)</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historyTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                    
                    <!-- ================= SCHEDULER TAB ================= -->
                    <div class="tab-pane fade"
                        id="schedulerTab"
                        role="tabpanel"
                        aria-labelledby="scheduler-tab">

                        <h5 class="mt-3">Create Schedule</h5>

                        <form id="schedulerForm" class="row g-3">

                            <div class="col-md-4">
                                <label class="form-label">Report Type</label>
                                <select class="form-select"
                                        id="schedReportType"
                                        name="report_type"
                                        required>
                                </select>
                            </div>

                            <div class="col-md-3">
                                <label class="form-label">Schedule Type</label>
                                <select class="form-select"
                                        id="schedType"
                                        name="schedule_type"
                                        required>
                                    <option value="once">Once</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Statuses</label>
                                <select class="form-select"
                                        id="schedStatuses"
                                        name="statuses"
                                        multiple>
                                </select>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Start Date</label>
                                <input type="date"
                                    class="form-control"
                                    id="schedStartDate"
                                    name="start_date"
                                    required>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">End Date</label>
                                <input type="date"
                                    class="form-control"
                                    id="schedEndDate"
                                    name="end_date"
                                    required>
                            </div>

                            <div class="col-md-2">
                                <div class="form-check mt-4">
                                    <input class="form-check-input"
                                        type="checkbox"
                                        id="schedTillNow"
                                        name="till_now">
                                    <label class="form-check-label">Till now</label>
                                </div>
                            </div>

                            <!-- Once -->
                            <div class="col-md-3" id="onceField">
                                <label class="form-label">Run Date</label>
                                <input type="date"
                                    class="form-control"
                                    id="schedDate"
                                    name="schedule_value">
                            </div>       
                            
                            <!-- Weekly -->
                            <div class="col-md-3" id="weeklyField" style="display:none">
                                <label class="form-label">Weekday</label>
                                <select class="form-select"
                                        id="schedWeekday"
                                        name="schedule_value">
                                    <option value="mon">Monday</option>
                                    <option value="tue">Tuesday</option>
                                    <option value="wed">Wednesday</option>
                                    <option value="thu">Thursday</option>
                                    <option value="fri">Friday</option>
                                    <option value="sat">Saturday</option>
                                    <option value="sun">Sunday</option>
                                </select>
                            </div>
                            
                            <!-- Monthly -->
                            <div class="col-md-3" id="monthlyField" style="display:none">
                                <label class="form-label">Day of Month</label>
                                <input type="number"
                                    min="1" max="31"
                                    class="form-control"
                                    id="schedDay"
                                    name="schedule_value">
                            </div>

                            <!-- Run Time -->
                            <div class="col-md-2">
                                <label class="form-label">Run Time</label>
                                <input type="time"
                                    class="form-control"
                                    id="schedTime"
                                    name="run_time"
                                    required>
                            </div>

                            <div class="col-md-2">
                                <label class="form-label">Last N days</label>
                                <input type="number"
                                    min="1"
                                    class="form-control"
                                    id="schedRangeDays"
                                    name="range_days">
                            </div>

                            <div class="col-md-4">
                                <label class="form-label">Email</label>
                                <input type="email"
                                    class="form-control"
                                    id="schedEmail"
                                    name="email_to"
                                    placeholder="user@example.com"
                                    required>
                            </div>

                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary">
                                    Create Schedule
                                </button>
                            </div>

                        </form>

                        <hr>

                        <h5>Existing Schedules</h5>
                        <table class="table table-sm" id="scheduleTable">
                            <thead>
                            <tr>
                                <th>Report</th>
                                <th>Dates</th>
                                <th>Status</th>
                                <th>Enabled</th>
                                <th>Action</th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                    </div>
                </div>

                <div class="text-center mt-4 footer-text">
                    Â© OnMobile â€¢ Jira Reporting Tool
                </div>

            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const form = document.getElementById("reportForm");
const btn = document.getElementById("submitBtn");
const bar = document.getElementById("progressBar");
const box = document.getElementById("progressBox");
const text = document.getElementById("progressText");
const cancelBtn = document.getElementById("cancelBtn");
let currentJobId = null;

// ðŸ”µ Status options per report type
const REPORT_STATUSES = {
    jira_infosol: [
        "Abandoned", "Accepted", "Closed", "Completed", "Deployed on Production", "Deployed on Staging", "Fixed", "In Progress", "Open", "Sent Back For Clarification", "Submitted"
    ],
    jira_ops: [
        "Approved", "Closed", "Completed", "Fixed", "In Progress", "Open", "Work Around"
    ],
    jira_ops_cr: [
        "Abandoned", "Accepted", "Closed", "Deployed on Production", "Deployed on Staging", "In Progress", "Need Clarification", "Pending For Review", "Submitted", "UAT Completed on Production", "UAT completed on Staging"
    ],
    jira_asd_incident: [
        "Assigned to L3 Team", "Auto Resolved", "Cancelled", "Escalated to L3", "Open", "Resolved", "Waiting"
    ],
    jira_asd_pm: [
        "Cancelled", "Closed", "Completed", "Open", "Pending", "Under investigation", "Under review", "Waiting for approval"
    ],
    jsm_incident: [
        "Assigned to Bot", "Assigned to L2 Team", "Assigned to L3 Team", "Auto Resolved", "Cancelled", "Escalated to L2", "Escalated to L3", "Resolved", "Waiting"
    ]
};

const reportSelect = document.getElementById("reportType");
const statusSelect = document.getElementById("statusSelect");

function updateStatusOptions() {
    const report = reportSelect.value;
    const statuses = REPORT_STATUSES[report] || [];

    statusSelect.innerHTML = "";

    statuses.forEach(status => {
        const opt = document.createElement("option");
        opt.value = status;
        opt.textContent = status;
        opt.selected = true; // default: select all
        statusSelect.appendChild(opt);
    });
}

reportSelect.addEventListener("change", updateStatusOptions);
updateStatusOptions(); // initial load

function toIST(utc) {
    if (!utc) return "";
    return new Date(utc).toLocaleString("en-IN", { timeZone: "Asia/Kolkata" });
}

form.addEventListener("submit", async (e) => {
    e.preventDefault();

    btn.disabled = true;
    btn.innerText = "Starting jobâ€¦";

    const res = await fetch("/start-job", {
        method: "POST",
        body: new FormData(form)
    });

    const { job_id } = await res.json();
    currentJobId = job_id;
    cancelBtn.classList.remove("d-none");

    poll(job_id);
});

async function poll(jobId) {
    const res = await fetch(`/job-status/${jobId}`);
    const data = await res.json();

    if (data.total && data.total > 0) {
        box.classList.remove("d-none");
        const percent = Math.floor((data.completed / data.total) * 100);
        bar.style.width = percent + "%";
        bar.innerText = percent + "%";
        text.innerText = `Fetched ${data.completed} / ${data.total} rows`;
    }

    if (["completed","failed","cancelled"].includes(data.status)) {
        if (data.status === "completed") {
            window.location = `/download/${jobId}`;
        }
        resetUI();
        switchToHistoryTab();
        loadHistory();
        return;
    }

    setTimeout(() => poll(jobId), 1000);
}

async function loadHistory() {
    const res = await fetch("/job-history");
    const jobs = await res.json();
    const table = document.getElementById("historyTable");
    table.innerHTML = "";

    jobs.forEach(job => {
        let badge = `<span class="badge bg-secondary">${job.status}</span>`;
        let action = "";

        if (job.status === "completed") {
            badge = `<span class="badge bg-success">Completed</span>`;
            action = `<a href="/download/${job.job_id}"
                        class="btn btn-sm btn-success">Download</a>`;
        }
        if (job.status === "failed") {
            badge = `<span class="badge bg-danger">Failed</span>`;
        }
        if (job.status === "cancelled") {
            badge = `<span class="badge bg-warning text-dark">Cancelled</span>`;
        }
        if (job.status === "running") {
            badge = `<span class="badge bg-primary">Running</span>`;
        }

        table.innerHTML += `
            <tr>
                <td>${job.report_name}</td>
                <td>${badge}</td>
                <td>${job.rows}</td>
                <td>${toIST(job.start_time)}</td>
                <td>${toIST(job.end_time)}</td>
                <td>${action}</td>
            </tr>
        `;
    });
}

function resetUI() {
    setTimeout(() => {
        btn.disabled = false;
        btn.innerText = "Generate & Download CSV";
        cancelBtn.classList.add("d-none");
        box.classList.add("d-none");
        bar.style.width = "0%";
        bar.innerText = "0%";
        text.innerText = "";
        currentJobId = null;
    }, 2000);
}

function switchToHistoryTab() {
    const tab = new bootstrap.Tab(
        document.getElementById("history-tab")
    );
    tab.show();
}

cancelBtn.addEventListener("click", async () => {
    if (!currentJobId) return;
    await fetch(`/cancel-job/${currentJobId}`, { method: "POST" });
    resetUI();
    loadHistory();
});

const tillNowCheckbox = document.getElementById("tillNow");
const endDateInput = document.querySelector('input[name="end_date"]');

tillNowCheckbox.addEventListener("change", () => {
    endDateInput.disabled = tillNowCheckbox.checked;
});

// Load history only when tab is opened
document.getElementById("history-tab")
    .addEventListener("shown.bs.tab", loadHistory);

/* ================= SCHEDULER JS (ADDITIVE ONLY) ================= */

// Schedule type toggle logic
const schedType = document.getElementById("schedType");
const onceField = document.getElementById("onceField");
const weeklyField = document.getElementById("weeklyField");
const monthlyField = document.getElementById("monthlyField");

function updateScheduleTypeUI() {
    onceField.style.display = "none";
    weeklyField.style.display = "none";
    monthlyField.style.display = "none";

    if (schedType.value === "once") {
        onceField.style.display = "block";
    }
    if (schedType.value === "weekly") {
        weeklyField.style.display = "block";
    }
    if (schedType.value === "monthly") {
        monthlyField.style.display = "block";
    }
}

schedType.addEventListener("change", updateScheduleTypeUI);

function initSchedulerUI() {
    const schedSelect = document.getElementById("schedReportType");

    // ðŸ” Clone options from Generate Report dropdown
    const generateSelect = document.getElementById("reportType");

    generateSelect.querySelectorAll("option").forEach(opt => {
        const cloned = opt.cloneNode(true);
        schedSelect.appendChild(cloned);
    });

    schedSelect.addEventListener("change", updateSchedStatuses);
    updateSchedStatuses();
}

function updateSchedStatuses() {
    const report = document.getElementById("schedReportType").value;
    const statusSelect = document.getElementById("schedStatuses");
    statusSelect.innerHTML = "";

    (REPORT_STATUSES[report] || []).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        opt.selected = true; // default select all
        statusSelect.appendChild(opt);
    });
}

// Till-now disables end date (scheduler only)
const schedTillNow = document.getElementById("schedTillNow");
const schedEndDate = document.getElementById("schedEndDate");
// ðŸ”µ FIX-1: "Last N days" overrides start/end/till-now (scheduler only)
const schedRangeDays = document.getElementById("schedRangeDays");
const schedStartDate = document.getElementById("schedStartDate");
// ðŸ”µ FIX 3: Declare scheduler DOM elements (REQUIRED)
const schedReportType = document.getElementById("schedReportType");
const schedStatuses = document.getElementById("schedStatuses");
const schedTime = document.getElementById("schedTime");
const schedEmail = document.getElementById("schedEmail");
const schedDate = document.getElementById("schedDate");
const schedWeekday = document.getElementById("schedWeekday");
const schedDay = document.getElementById("schedDay");

function updateRangeDaysUI() {
    const hasRangeDays =
        schedRangeDays.value &&
        parseInt(schedRangeDays.value, 10) > 0;

    schedStartDate.disabled = hasRangeDays;
    schedEndDate.disabled = hasRangeDays;
    schedTillNow.disabled = hasRangeDays;

    if (hasRangeDays) {
        // ðŸ”µ Last N days = past days only (NOT till now)
        schedTillNow.checked = false;
        schedStartDate.value = "";
        schedEndDate.value = ""; 
    }
}

// react immediately when user types
schedRangeDays.addEventListener("input", updateRangeDaysUI);


schedTillNow.addEventListener("change", () => {
    schedEndDate.disabled = schedTillNow.checked;
});

// Submit scheduler form

document.getElementById("schedulerForm").addEventListener("submit", async e => {
    e.preventDefault();

    const fd = new FormData();

    // always-required
    fd.append("report_type", schedReportType.value);
    // fd.append("start_date", schedStartDate.value);
    if (schedRangeDays.value && parseInt(schedRangeDays.value, 10) > 0) {
        // dummy value â€“ backend will override
        fd.append("start_date", new Date().toISOString().slice(0, 10));
    } else {
        fd.append("start_date", schedStartDate.value);
    }
    // ðŸ”µ end_date is REQUIRED by backend
    if (schedRangeDays.value && parseInt(schedRangeDays.value, 10) > 0) {
        // Last N days â†’ dummy end_date (will be ignored)
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        fd.append("end_date", yesterday.toISOString().slice(0, 10));
    }
    else if (schedTillNow.checked) {
        fd.append("end_date", new Date().toISOString().slice(0, 10));
    }
    else {
        fd.append("end_date", schedEndDate.value);
    }

    fd.append("statuses",
        [...schedStatuses.selectedOptions].map(o => o.value).join(",")
    );
    fd.append("till_now", schedTillNow.checked);
    fd.append("schedule_type", schedType.value);
    fd.append("run_time", schedTime.value);
//  fd.append("range_days", schedRangeDays.value);
    if (schedRangeDays.value && parseInt(schedRangeDays.value, 10) > 0) {
    fd.append("range_days", schedRangeDays.value);
    } else {
        fd.append("range_days", 0);
    }
    fd.append("email_to", schedEmail.value);

    // conditional schedule_value
    if (schedType.value === "once") {
        fd.append("schedule_value", schedDate.value);
    }
    if (schedType.value === "weekly") {
        fd.append("schedule_value", schedWeekday.value);
    }
    if (schedType.value === "monthly") {
        fd.append("schedule_value", schedDay.value);
    }

    const res = await fetch("/schedule-job", {
        method: "POST",
        body: fd
    });

    if (!res.ok) {
        const err = await res.text();
        alert("Failed to create schedule:\n" + err);
        return;
    }

    alert("Schedule created successfully");
    loadSchedules();
});

async function loadSchedules() {
    const res = await fetch("/schedules");
    const data = await res.json();

    const tbody = document.querySelector("#scheduleTable tbody");
    tbody.innerHTML = "";

    data.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${s.report_type}</td>
            <td>
            ${s.range_days ? `Last ${s.range_days} days` : `${s.start_date} â†’ ${s.end_date}`}
            </td>
            <td>${s.statuses || "-"}</td>
            <td>${s.enabled ? "Yes" : "No"}</td>
            <td>
                <button class="btn btn-sm btn-secondary"
                        onclick="toggleSchedule('${s.id}', ${s.enabled ? 0 : 1})">
                    ${s.enabled ? "Disable" : "Enable"}
                </button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

async function toggleSchedule(id, enabled) {
    const fd = new FormData();
    fd.append("enabled", enabled);
    await fetch(`/schedule/${id}/toggle`, { method: "POST", body: fd });
    loadSchedules();
}

document.addEventListener("DOMContentLoaded", () => {
    initSchedulerUI();
    updateScheduleTypeUI();
    updateRangeDaysUI();
    loadSchedules();
});

</script>

</body>
</html>